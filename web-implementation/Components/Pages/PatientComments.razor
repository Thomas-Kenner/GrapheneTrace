@page "/patient/comments"
@rendermode InteractiveServer
@inject PressureCommentService CommentService
@inject AuthenticationStateProvider AuthState
@using GrapheneTrace.Web.Data.Entities
@using GrapheneTrace.Web.Services
@using Microsoft.AspNetCore.Components.Authorization


<h3>Pressure Map Comments</h3>

@if (!string.IsNullOrEmpty(StatusMessage))
{
    <p style="color:@StatusColor"><b>@StatusMessage</b></p>
}

<textarea class="form-control" @bind="NewComment" placeholder="Enter your comment"></textarea>
<br />
<button class="btn btn-primary" @onclick="Submit">Submit Comment</button>

<hr />

<h4>Your Previous Comments</h4>

@if (Comments == null)
{
    <p>Loading...</p>
}
else if (!Comments.Any())
{
    <p>No comments yet.</p>
}
else
{
    <ul>
        @foreach (var comment in Comments)
        {
            <li>
                <b>@comment.CreatedAt.ToLocalTime()</b>: @comment.Comment
                @if (!string.IsNullOrEmpty(comment.Reply))
                {
                    <p style="color: green;"><b>Clinician:</b> @comment.Reply</p>
                }
            </li>
        }
    </ul>
}

@code {

    private List<PressureComment> Comments = new();
    private string NewComment = "";

    private string StatusMessage = "";
    private string StatusColor = "green";

    protected override async Task OnInitializedAsync()
    {
        await LoadComments();
    }

    private async Task LoadComments()
    {
        var auth = await AuthState.GetAuthenticationStateAsync();
        var user = auth.User;
        var id = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (!Guid.TryParse(id, out var userId))
        {
            StatusColor = "red";
            StatusMessage = "ERROR: User ID not found.";
            return;
        }

        Comments = await CommentService.GetCommentsForPatientAsync(userId);
        StateHasChanged();
    }

    private async Task Submit()
{
    StatusMessage = "DEBUG: Button clicked";
    StatusColor = "orange";
    StateHasChanged();

    try
    {
        var auth = await AuthState.GetAuthenticationStateAsync();
        var user = auth.User;
        var id = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (!Guid.TryParse(id, out var userId))
        {
            StatusColor = "red";
            StatusMessage = "❌ User ID not found";
            return;
        }

        if (string.IsNullOrWhiteSpace(NewComment))
        {
            StatusColor = "red";
            StatusMessage = "❌ Comment empty";
            return;
        }

        StatusMessage = "DEBUG: Saving...";
        StateHasChanged();

        await CommentService.AddCommentAsync(userId, userId, NewComment);

        StatusMessage = "DEBUG: Reloading...";
        NewComment = "";
        await LoadComments();

        StatusColor = "green";
        StatusMessage = "✅ Comment added successfully!";
    }
    catch (Exception ex)
    {
        StatusColor = "red";
        StatusMessage = "❌ " + ex.Message;
    }

    StateHasChanged();
}

}
