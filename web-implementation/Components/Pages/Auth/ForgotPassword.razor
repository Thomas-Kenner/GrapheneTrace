@page "/forgot-password"
@layout Layout.AuthLayout
@using GrapheneTrace.Web.Components.UI
@using GrapheneTrace.Web.Data
@using GrapheneTrace.Web.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@inject NavigationManager Navigation
@inject ApplicationDbContext DbContext
@inject UserManager<ApplicationUser> UserManager
@rendermode InteractiveServer

@*
    FORGOT PASSWORD PAGE
    Author: 2402513
    Route: /forgot-password

    Purpose: Allows users to reset their password by entering email and new password.

    Current Implementation: Simple reset without email verification (for testing/demo).
    #TODO: Implement safer password reset flow with:
    - Email verification token generation
    - Secure token validation
    - Time-limited tokens (15-30 minutes)
    - Email notification with reset link
    - Rate limiting to prevent brute force attacks
    - HTTPS enforcement

    Design Pattern: Traditional HTML form with async C# backend processing.
    Why: Same reasoning as Login page - cookie/header restrictions in Blazor Server.

    Current Flow:
    1. User enters email address
    2. User enters new password
    3. Backend finds user and updates password hash
    4. Redirect to login with success message

    Layout: AuthLayout
    Why: Minimal layout to focus on authentication task.

    InteractiveServer render mode: Needed for form submission and database access.
*@

<link rel="stylesheet" href="css/auth.css" />

<div class="auth-container">
    <Card>
        <CardHeader>
            <h1 class="card-title">Reset Password</h1>
            <p class="card-description">Enter your email and new password to reset your account</p>
        </CardHeader>

        @if (!resetSuccessful)
        {
            <EditForm Model="@resetModel" OnValidSubmit="HandlePasswordReset">
                <DataAnnotationsValidator />
                <CardContent>
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div style="background: #fee2e2; border: 1px solid #fca5a5; color: #dc2626; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem;">
                            <strong>Error:</strong> @errorMessage
                        </div>
                    }

                    <FormGroup Label="Email Address"
                               Id="email"
                               InputType="email"
                               @bind-Value="resetModel.Email"
                               Required="true"
                               Placeholder="john@example.com" />

                    <FormGroup Label="New Password"
                               Id="password"
                               InputType="password"
                               @bind-Value="resetModel.NewPassword"
                               Required="true"
                               Placeholder="••••••••" />

                    <FormGroup Label="Confirm Password"
                               Id="confirm-password"
                               InputType="password"
                               @bind-Value="resetModel.ConfirmPassword"
                               Required="true"
                               Placeholder="••••••••" />
                </CardContent>

                <CardFooter>
                    <div style="width: 100%; display: flex; flex-direction: column; gap: 1rem;">
                        <Button FullWidth="true" Type="submit">
                            Reset Password
                        </Button>
                        <p class="text-center text-muted">
                            Remember your password? <a href="/" class="link-text">Sign in</a>
                        </p>
                    </div>
                </CardFooter>
            </EditForm>
        }
        else
        {
            <CardContent>
                <div style="background: #d1fae5; border: 1px solid #a7f3d0; color: #065f46; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem; text-align: center;">
                    <strong style="display: block; margin-bottom: 0.5rem;">✓ Password Reset Successfully</strong>
                    <p style="margin: 0; font-size: 0.95rem;">Your password has been updated. You can now sign in with your new password.</p>
                </div>
            </CardContent>

            <CardFooter>
                <div style="width: 100%; display: flex; flex-direction: column; gap: 1rem;">
                    <Button FullWidth="true" Type="button" @onclick="RedirectToLogin">
                        Back to Sign In
                    </Button>
                </div>
            </CardFooter>
        }
    </Card>
</div>

@code {
    private ResetPasswordModel resetModel = new();
    private string? errorMessage = null;
    private bool resetSuccessful = false;

    /// <summary>
    /// Handles password reset form submission.
    /// Author: 2402513
    /// </summary>
    /// <remarks>
    /// Current implementation is simplified for testing purposes.
    /// In production, this should:
    /// - Send password reset email with secure token
    /// - Validate token expiration
    /// - Hash password using Identity's password hasher
    /// - Log the password reset event for audit trail
    /// - Implement rate limiting per email address
    /// </remarks>
    private async Task HandlePasswordReset()
    {
        errorMessage = null;

        // Validate passwords match
        if (resetModel.NewPassword != resetModel.ConfirmPassword)
        {
            errorMessage = "Passwords do not match.";
            return;
        }

        // Validate password strength
        if (string.IsNullOrWhiteSpace(resetModel.NewPassword) || resetModel.NewPassword.Length < 6)
        {
            errorMessage = "Password must be at least 6 characters long.";
            return;
        }

        try
        {
            // Updated: 2402513 - Security fix: Don't reveal if email exists or not
            // Always show success message to prevent email enumeration attacks
            var user = await UserManager.FindByEmailAsync(resetModel.Email);

            if (user != null)
            {
                // Reset password using UserManager (same as account creation)
                // This properly hashes the password and updates the SecurityStamp
                var result = await UserManager.RemovePasswordAsync(user);
                if (result.Succeeded)
                {
                    result = await UserManager.AddPasswordAsync(user, resetModel.NewPassword);
                    if (!result.Succeeded)
                    {
                        // Log error but don't reveal to user
                        // In production, log this for monitoring
                        Console.WriteLine($"Password reset failed for user {user.Id}: {string.Join(", ", result.Errors.Select(e => e.Description))}");
                    }
                }
                else
                {
                    // Log error but don't reveal to user
                    Console.WriteLine($"Password removal failed for user {user.Id}: {string.Join(", ", result.Errors.Select(e => e.Description))}");
                }
            }
            // If user doesn't exist, we still show success to prevent email enumeration
            // This is a security best practice - don't reveal which emails are registered

            resetSuccessful = true;
        }
        catch (Exception ex)
        {
            // Log error but show generic success message to user
            // This prevents revealing system errors that could be exploited
            Console.WriteLine($"Password reset error: {ex.Message}");
            resetSuccessful = true; // Still show success to prevent information leakage
        }
    }

    /// <summary>
    /// Redirects user back to login page.
    /// Author: 2402513 (original implementation)
    /// Updated: 2402513 - Changed redirect from /login to / to match updated login page route
    /// </summary>
    private void RedirectToLogin()
    {
        Navigation.NavigateTo("/");
    }

    /// <summary>
    /// Model for password reset form.
    /// </summary>
    public class ResetPasswordModel
    {
        public string Email { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
