@*
    ========================================
    SESSIONS PAGE
    ========================================
    Author: SID:2402513
    Updated: SID:2412494 - Added real session data and heatmap playback

    Purpose:
    View past monitoring sessions with detailed pressure maps,
    comments, and alert history.
*@

@page "/patient/sessions"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Patient")]
@using GrapheneTrace.Web.Models
@using GrapheneTrace.Web.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@inject AuthenticationStateProvider AuthStateProvider
@inject PressureDataService PressureDataService
@inject HeatmapPlaybackService PlaybackService
@inject PressureCommentService CommentService
@inject IJSRuntime JS
@implements IAsyncDisposable

<div class="patient-container">
    <PatientHeader />

    <div class="patient-content">
        <div class="sessions-grid">
            <div class="sessions-sidebar">
                <div class="card sidebar-card">
                    <h3 class="sidebar-title">Session History</h3>
                    <p class="sidebar-subtitle">Past monitoring sessions</p>

                    <div class="sessions-list">
                        @if (isLoading)
                        {
                            <div class="session-item">
                                <div class="session-header">
                                    <span class="session-date">Loading sessions...</span>
                                </div>
                            </div>
                        }
                        else if (sessions == null || sessions.Count == 0)
                        {
                            <div class="session-item">
                                <div class="session-header">
                                    <span class="session-date">No sessions found</span>
                                </div>
                            </div>
                        }
                        else
                        {
                            @foreach (var session in sessions)
                            {
                                <div class="session-item @(selectedSessionId == session.SessionId ? "active" : "")"
                                     @onclick="() => SelectSessionAsync(session)">
                                    <div class="session-header">
                                        <span class="session-date">@session.Start.ToString("MMM dd, yyyy")</span>
                                        @if (session.ClinicianFlag)
                                        {
                                            <span class="alert-badge">Flagged</span>
                                        }
                                        else
                                        {
                                            <span class="no-alert">No Flags</span>
                                        }
                                    </div>
                                    <div class="session-details">
                                        <span class="session-duration">@FormatDuration(session.Start, session.End)</span>
                                        @if (session.PeakSessionPressure.HasValue)
                                        {
                                            <span class="session-pressure">Peak: @session.PeakSessionPressure mmHg</span>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>

            <div class="session-detail">
                <div class="card session-header-card">
                    <div class="session-title-row">
                        <div>
                            @if (selectedSession != null)
                            {
                                <h3 class="session-title">Session: @selectedSession.Start.ToString("MMMM dd, yyyy")</h3>
                                <p class="session-time">
                                    Started: @selectedSession.Start.ToString("HH:mm:ss")
                                    (@FormatDuration(selectedSession.Start, selectedSession.End))
                                </p>
                            }
                            else
                            {
                                <h3 class="session-title">Select a session</h3>
                                <p class="session-time">Choose a session from the list to view details</p>
                            }
                        </div>
                        <button class="add-comment-btn" @onclick="OpenCommentOverlay"
                                disabled="@(selectedSession == null)">Add Comment</button>
                    </div>
                </div>

                <div class="card visualization-card">
                    @if (selectedSession != null)
                    {
                        <div class="heatmap-container">
                            <canvas id="@canvasId"></canvas>
                        </div>
                        @if (PlaybackService.TotalFrames > 0)
                        {
                            <div class="playback-controls">
                                @* Progress Bar *@
                                <div class="progress-container @(isDragging ? "dragging" : "")"
                                     @onmousedown="OnProgressMouseDown"
                                     @onmousemove="OnProgressMouseMove"
                                     @onmouseup="OnProgressMouseUp"
                                     @onmouseleave="OnProgressMouseUp">
                                    <div class="progress-track">
                                        <div class="progress-fill" style="width: @(GetProgressPercent())%;"></div>
                                    </div>
                                    <div class="progress-label">
                                        @(PlaybackService.CurrentFrameIndex + 1) / @PlaybackService.TotalFrames
                                    </div>
                                </div>

                                @* Play/Pause Button *@
                                <button class="playback-btn" @onclick="TogglePlayback">
                                    @if (PlaybackService.IsPlaying)
                                    {
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="6" y="4" width="4" height="16"></rect>
                                            <rect x="14" y="4" width="4" height="16"></rect>
                                        </svg>
                                        <span>Pause</span>
                                    }
                                    else
                                    {
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="5,3 19,12 5,21"></polygon>
                                        </svg>
                                        <span>Play</span>
                                    }
                                </button>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="visualization-placeholder">
                            <p class="placeholder-text">No Session Selected</p>
                            <p class="placeholder-description">Select a session from the list to view the pressure heatmap</p>
                        </div>
                    }
                </div>

                <div class="detail-grid">
                    <div class="card comments-card">
                        <h4 class="section-title">Comments & Notes</h4>
                        <div class="comments-list">
                            @* Session comments display - Author: SID:2412494 *@
                            @if (sessionComments == null || sessionComments.Count == 0)
                            {
                                <div class="comment-item">
                                    <div class="comment-time">--</div>
                                    <div class="comment-text">No comments for this session</div>
                                </div>
                            }
                            else
                            {
                                @foreach (var comment in sessionComments)
                                {
                                    <div class="comment-item">
                                        <div class="comment-time">
                                            Frame @((comment.FrameIndex ?? 0) + 1)
                                        </div>
                                        <div class="comment-text">@comment.Comment</div>
                                        @if (!string.IsNullOrEmpty(comment.Reply))
                                        {
                                            <div class="comment-reply">
                                                <strong>Clinician:</strong> @comment.Reply
                                            </div>
                                        }
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <div class="card alerts-card">
                        <h4 class="section-title">Session Alerts</h4>
                        <div class="alerts-list">
                            <div class="alert-item-session">
                                <div class="alert-time-badge">--</div>
                                <div class="alert-text">No alerts for this session</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Comment Overlay - Author: SID:2412494 *@
    @if (showCommentOverlay)
    {
        <div class="comment-overlay-backdrop" @onclick="CloseCommentOverlay">
            <div class="comment-overlay" @onclick:stopPropagation="true">
                <div class="comment-overlay-header">
                    <h4>Add Comment</h4>
                    <button class="close-btn" @onclick="CloseCommentOverlay">&times;</button>
                </div>
                <div class="comment-overlay-body">
                    <p class="frame-info">
                        Frame @(capturedFrameIndex + 1) of @PlaybackService.TotalFrames
                    </p>
                    <textarea class="comment-textarea"
                              placeholder="Enter your comment about this frame..."
                              @bind="newCommentText"
                              rows="4"></textarea>
                    @if (!string.IsNullOrEmpty(commentError))
                    {
                        <p class="comment-error">@commentError</p>
                    }
                </div>
                <div class="comment-overlay-footer">
                    <button class="btn-cancel" @onclick="CloseCommentOverlay">Cancel</button>
                    <button class="btn-submit" @onclick="SubmitComment" disabled="@isSubmittingComment">
                        @(isSubmittingComment ? "Submitting..." : "Submit Comment")
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    // Author: SID:2412494
    private List<PatientSessionData>? sessions;
    private PatientSessionData? selectedSession;
    private int? selectedSessionId;
    private bool isLoading = true;
    private string canvasId = $"heatmap-{Guid.NewGuid():N}";
    private bool isInitialized;
    private bool isPlaybackInitialized;

    // Comment overlay state - Author: SID:2412494
    private bool showCommentOverlay;
    private string newCommentText = "";
    private string? commentError;
    private bool isSubmittingComment;
    private int capturedFrameIndex;
    private Guid _userId;
    private List<PressureComment>? sessionComments;

    protected override async Task OnInitializedAsync()
    {
        // Author: SID:2412494 - Capture user ID for comments
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userIdClaim = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
        if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var userId))
        {
            _userId = userId;
        }

        await LoadSessionsAsync();
    }

    // Author: SID:2412494
    // Auto-select moved here from OnInitializedAsync to avoid DbContext concurrency issues
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            isInitialized = true;

            // Auto-select first session after initial render completes
            // This is safe here because LoadSessionsAsync has fully completed
            if (sessions != null && sessions.Count > 0 && selectedSessionId == null)
            {
                await SelectSessionAsync(sessions[0]);
            }
        }
    }

    private async Task LoadSessionsAsync()
    {
        try
        {
            isLoading = true;

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);

            if (userIdClaim == null || !Guid.TryParse(userIdClaim.Value, out var userId))
            {
                // Unable to identify user
                sessions = new List<PatientSessionData>();
                return;
            }

            sessions = await PressureDataService.GetSessionsForPatientAsync(userId);

            // Author: SID:2412494
            // Note: Auto-select moved to OnAfterRenderAsync to avoid DbContext concurrency
            // issues. The fire-and-forget call was causing "A second operation was started"
            // errors because it ran concurrently with LoadSessionsAsync.
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading sessions: {ex.Message}");
            sessions = new List<PatientSessionData>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SelectSessionAsync(PatientSessionData session)
    {
        if (selectedSessionId == session.SessionId)
            return;

        selectedSession = session;
        selectedSessionId = session.SessionId;
        StateHasChanged();

        // Wait for render if needed
        if (!isInitialized)
        {
            await Task.Delay(100);
        }

        // Initialize playback service if not already done
        if (!isPlaybackInitialized)
        {
            await PlaybackService.InitializeAsync(canvasId);
            isPlaybackInitialized = true;
        }
        else
        {
            // Pause current playback before loading new session
            await PlaybackService.PausePlaybackAsync();
        }

        // Load the session into the playback service
        var loaded = await PlaybackService.LoadSessionAsync(session.SessionId);
        if (loaded)
        {
            // Subscribe to frame changes to update UI
            PlaybackService.OnFrameChanged += OnFrameChanged;

            // Start playback (loops automatically)
            PlaybackService.StartPlayback();
        }

        // Load comments for this session - Author: SID:2412494
        await LoadSessionCommentsAsync();

        StateHasChanged();
    }

    private void OnFrameChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private double GetProgressPercent()
    {
        if (PlaybackService.TotalFrames == 0)
            return 0;
        return (double)PlaybackService.CurrentFrameIndex / (PlaybackService.TotalFrames - 1) * 100;
    }

    // Dragging state for progress bar
    private bool isDragging;

    private async Task OnProgressMouseDown(MouseEventArgs e)
    {
        isDragging = true;

        // Pause playback when starting to drag
        await PlaybackService.PausePlaybackAsync();

        // Seek to clicked position
        await SeekToMousePosition(e);
    }

    private async Task OnProgressMouseMove(MouseEventArgs e)
    {
        if (!isDragging)
            return;

        // Continue seeking while dragging
        await SeekToMousePosition(e);
    }

    private void OnProgressMouseUp(MouseEventArgs e)
    {
        isDragging = false;
    }

    private async Task SeekToMousePosition(MouseEventArgs e)
    {
        // The progress track is 400px wide (fixed width)
        const double trackWidth = 400.0;
        var clickPercent = Math.Clamp(e.OffsetX / trackWidth, 0, 1);
        var targetFrame = (int)(clickPercent * (PlaybackService.TotalFrames - 1));

        await PlaybackService.SeekToFrameAsync(targetFrame);
        StateHasChanged();
    }

    private async Task TogglePlayback()
    {
        await PlaybackService.TogglePlaybackAsync();
        StateHasChanged();
    }

    private string FormatDuration(DateTime start, DateTime? end)
    {
        if (!end.HasValue)
            return "Duration unknown";

        var duration = end.Value - start;
        if (duration.TotalHours >= 1)
            return $"{duration.Hours}h {duration.Minutes}m";
        if (duration.TotalMinutes >= 1)
            return $"{duration.Minutes}m {duration.Seconds}s";
        return $"{duration.Seconds}s";
    }

    // Comment overlay methods - Author: SID:2412494
    private async Task OpenCommentOverlay()
    {
        if (selectedSession == null || PlaybackService.CurrentSessionId == null)
            return;

        // Pause playback and capture current frame
        await PlaybackService.PausePlaybackAsync();
        capturedFrameIndex = PlaybackService.CurrentFrameIndex;

        // Reset state and show overlay
        newCommentText = "";
        commentError = null;
        showCommentOverlay = true;
        StateHasChanged();
    }

    private void CloseCommentOverlay()
    {
        showCommentOverlay = false;
        newCommentText = "";
        commentError = null;
    }

    private async Task SubmitComment()
    {
        if (string.IsNullOrWhiteSpace(newCommentText))
        {
            commentError = "Please enter a comment.";
            return;
        }

        if (_userId == Guid.Empty || PlaybackService.CurrentSessionId == null)
        {
            commentError = "Unable to submit comment. Please try again.";
            return;
        }

        isSubmittingComment = true;
        commentError = null;
        StateHasChanged();

        try
        {
            await CommentService.AddCommentAsync(
                _userId,
                _userId,
                newCommentText,
                PlaybackService.CurrentSessionId,
                capturedFrameIndex
            );

            // Close overlay and reload comments
            showCommentOverlay = false;
            newCommentText = "";
            await LoadSessionCommentsAsync();
        }
        catch (Exception)
        {
            commentError = "Failed to submit comment. Please try again.";
        }
        finally
        {
            isSubmittingComment = false;
        }
    }

    private async Task LoadSessionCommentsAsync()
    {
        if (selectedSessionId == null)
        {
            sessionComments = null;
            return;
        }

        try
        {
            sessionComments = await CommentService.GetCommentsForSessionAsync(selectedSessionId.Value);
        }
        catch
        {
            sessionComments = new List<PressureComment>();
        }
    }

    public async ValueTask DisposeAsync()
    {
        PlaybackService.OnFrameChanged -= OnFrameChanged;
        await PlaybackService.DisposeAsync();
    }
}
