@*
    ========================================
    PATIENT DASHBOARD PAGE
    ========================================
    Author: SID:2402513
    Updated: SID:2412494 - Added live mock device heatmap with Connect Device button
    Updated: SID:2412494 - Added browser notification integration (Stories #10, #18)

    Purpose:
    Main patient dashboard providing real-time pressure monitoring, alerts,
    device status, and weekly insights.

    How it works:
    - Uses Blazor's @page directive to map to /patient/dashboard route
    - Implements InteractiveServer render mode for real-time updates
    - Connect Device button creates a mock device and streams live data
    - Uses JS canvas rendering for efficient heatmap visualization
    - Triggers browser notifications when pressure exceeds thresholds (Story #10)
    - Alerts on equipment faults (Story #18)
    - Receives clinician notifications via SignalR (Story #28)
*@

@page "/patient/dashboard"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Patient")]
@using GrapheneTrace.Web.Models
@using GrapheneTrace.Web.Services
@using GrapheneTrace.Web.Services.Mocking
@using GrapheneTrace.Web.Hubs
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@inject AuthenticationStateProvider AuthStateProvider
@inject MockDeviceManager DeviceManager
@inject NotificationService NotificationService
@inject AlertService AlertService
@inject PatientSettingsService PatientSettingsService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject IConfiguration Configuration
@inject PressureDataService PressureDataService
@implements IAsyncDisposable

<div class="patient-container">
    <header class="patient-header">
        <div class="header-left">
            <span class="header-brand">Sensore GrapheneTrace</span>
            <span class="header-subtitle">Patient Dashboard</span>
        </div>
        <div class="header-right">
            <button class="icon-btn" title="Notifications">üîî</button>
            <button class="icon-btn" title="Settings">‚öôÔ∏è</button>
            <form method="post" action="/account/logout" class="logout-form">
                <button type="submit" class="btn-signout">Sign Out</button>
            </form>
        </div>
    </header>

    <nav class="patient-nav">
        <button class="nav-tab active">Dashboard</button>
        <button class="nav-tab">Pressure Data</button>
        <button class="nav-tab">Sessions</button>
        <button class="nav-tab">Settings</button>
        <button class="nav-tab">Support</button>
    </nav>

    @* Author: SID:2412494 - Notification permission banner (Story #10) *@
    @if (_showNotificationBanner)
    {
        <div class="notification-permission-banner">
            <div class="banner-content">
                <span class="banner-icon">üîî</span>
                <span class="banner-text">Enable notifications to receive pressure alerts even when this tab is in the background.</span>
                <button class="banner-btn enable" @onclick="RequestNotificationPermissionAsync">Enable Notifications</button>
                <button class="banner-btn dismiss" @onclick="DismissNotificationBanner">Not Now</button>
            </div>
        </div>
    }

    @* Author: SID:2412494 - Clinician message toast (Story #28) *@
    @if (_clinicianMessage != null)
    {
        <div class="clinician-message-toast">
            <div class="toast-icon">üí¨</div>
            <div class="toast-content">
                <strong>Message from your clinician:</strong>
                <p>@_clinicianMessage</p>
            </div>
            <button class="toast-dismiss" @onclick="DismissClinicianMessage">√ó</button>
        </div>
    }

    <!-- Main Content -->
    <div class="patient-content">
        <div class="dashboard-grid">
            <div class="left-column">
                @*
                    LIVE MONITORING CARD
                    Shows real-time pressure heatmap from mock device
                *@
                <div class="card live-monitoring-card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">Live Monitoring</h3>
                            <p class="card-subtitle">Real-time pressure</p>
                        </div>
                        @if (_isConnected)
                        {
                            <span class="live-badge">
                                <span class="live-dot"></span> Live
                            </span>
                        }
                        else
                        {
                            <span class="offline-badge">Offline</span>
                        }
                    </div>

                    <div class="heatmap-placeholder">
                        @if (_isConnected)
                        {
                            @* Author: SID:2412494 - JS Canvas heatmap *@
                            <div class="heatmap-container">
                                <canvas id="@_canvasId"></canvas>
                            </div>
                        }
                        else
                        {
                            @* Connect Device Button *@
                            <div class="connect-device-prompt">
                                <div class="device-icon-large">üì°</div>
                                <p class="connect-message">No device connected</p>
                                <button class="connect-btn" @onclick="ConnectDeviceAsync" disabled="@_isConnecting">
                                    @if (_isConnecting)
                                    {
                                        <span>Connecting...</span>
                                    }
                                    else
                                    {
                                        <span>Connect Device</span>
                                    }
                                </button>
                            </div>
                        }
                    </div>

                    <div class="metrics-strip">
                        <div class="metric-item">
                            <span class="metric-label">Peak</span>
                            <span class="metric-value @GetPeakPressureClass()">
                                @(_currentFrame?.PeakPressure.ToString() ?? "N/A")
                            </span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Contact</span>
                            <span class="metric-value">
                                @(_currentFrame != null ? $"{_currentFrame.ContactAreaPercent:F1}%" : "N/A")
                            </span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Frame</span>
                            <span class="metric-value">
                                @(_device?.TotalFrames.ToString() ?? "N/A")
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-column">
                @*
                    HIGH PRESSURE ALERT CARD
                    Author: SID:2412494 - Updated to show equipment faults (Story #18)
                    Turns red when alert system detects threshold breach
                    Shows equipment fault icon when device has issues
                *@
                <div class="card alert-card @GetAlertCardClass()">
                    <div class="alert-icon-container">
                        <div class="alert-icon">@GetAlertIcon()</div>
                    </div>
                    <h4 class="alert-title">@GetAlertTitle()</h4>
                    <p class="alert-message">@GetAlertMessage()</p>
                    @if (_patientSettings != null && _isConnected)
                    {
                        <p class="threshold-info">Your threshold: @_patientSettings.HighPressureThreshold</p>
                    }
                </div>

                @* Author: SID:2412494 - Equipment fault indicator (Story #18) *@
                @if (_currentFaults != DeviceFault.None)
                {
                    <div class="card equipment-fault-card">
                        <div class="fault-header">
                            <span class="fault-icon">üîß</span>
                            <h4 class="fault-title">Equipment Issue</h4>
                        </div>
                        <p class="fault-description">@GetFaultDescription()</p>
                        <p class="fault-advice">@GetFaultAdvice()</p>
                    </div>
                }

                @*
                    DEVICE CONNECTED STATUS CARD
                *@
                <div class="card device-card @(_isConnected ? "connected" : "")">
                    <div class="device-header">
                        <div class="device-icon">@(_isConnected ? "‚úì" : "‚ö°")</div>
                        <h4 class="device-title">@(_isConnected ? "Device Connected" : "Device Disconnected")</h4>
                    </div>
                    @if (_isConnected && _device != null)
                    {
                        <p class="device-status">ID: @_device.DeviceId</p>
                        <p class="device-update">Scenario: @_device.CurrentScenario</p>
                        <div class="device-controls">
                            <button class="scenario-btn" @onclick="CycleScenario">Change Scenario</button>
                            <button class="fault-btn" @onclick="InjectRandomFault">Inject Fault</button>
                        </div>
                        <button class="disconnect-btn" @onclick="DisconnectDeviceAsync">Disconnect Device</button>
                    }
                    else
                    {
                        <p class="device-status">Sensor offline. Awaiting connection.</p>
                        <p class="device-update">Last update: --</p>
                    }
                </div>

                @*
                    WEEKLY SUMMARY CARD
                    Author: SID:2412494 - Updated to show real weekly stats with motivational message
                *@
                <div class="card summary-card">
                    <h4 class="summary-title">Weekly Summary</h4>
                    <p class="summary-subtitle">Your Progress</p>
                    <div class="summary-content">
                        @if (_sessionsThisWeek > 0 || _alertsThisWeek > 0)
                        {
                            <p class="summary-stats">
                                @if (_sessionsThisWeek > 0)
                                {
                                    <span>@_sessionsThisWeek monitoring session@(_sessionsThisWeek != 1 ? "s" : "") this week.</span>
                                }
                                @if (_alertsThisWeek == 0)
                                {
                                    <span> No pressure alerts - great job!</span>
                                }
                                else if (_alertsThisWeek < _alertsLastWeek)
                                {
                                    <span> Alerts down from last week - keep it up!</span>
                                }
                            </p>
                        }
                        <p class="inspirational-quote">"@randomQuote"</p>
                    </div>
                </div>

                @*
                    STATS GRID - 3 mini cards
                    Author: SID:2412494 - Updated to show real stats from database
                *@
                <div class="stats-mini-grid">
                    <div class="card stat-mini-card">
                        <h5 class="stat-mini-title">Sessions This Week</h5>
                        <p class="stat-mini-value">@_sessionsThisWeek</p>
                        <p class="stat-mini-detail">Total: @_sessionsTotal</p>
                    </div>
                    <div class="card stat-mini-card">
                        <h5 class="stat-mini-title">Alerts This Week</h5>
                        <p class="stat-mini-value">@_alertsThisWeek</p>
                        <p class="stat-mini-detail">@GetAlertComparisonText()</p>
                    </div>
                    <div class="card stat-mini-card">
                        <h5 class="stat-mini-title">Device Status</h5>
                        <p class="stat-mini-value">@(_isConnected ? "Active" : "Offline")</p>
                        <p class="stat-mini-detail">@(_device != null ? $"FPS: {_device.FramesPerSecond}" : "N/A")</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // Author: SID:2412494
    private string userName = "";
    private string randomQuote = "";

    // Mock device state
    private MockHeatmapDevice? _device;
    private HeatmapFrame? _currentFrame;
    private bool _isConnected;
    private bool _isConnecting;
    private bool _isCanvasInitialized;
    private string _canvasId = $"live-heatmap-{Guid.NewGuid():N}";
    private Guid _userId;

    // Configuration values
    private int _minValue;
    private int _maxValue;

    // Current alert state
    private MedicalAlert _currentAlerts = MedicalAlert.None;

    // Author: SID:2412494 - Notification state (Stories #10, #18, #28)
    private bool _showNotificationBanner;
    private bool _notificationsEnabled;
    private PatientSettings? _patientSettings;
    private DeviceFault _currentFaults = DeviceFault.None;
    private string? _clinicianMessage;
    private HubConnection? _alertHubConnection;

    // Scenario cycling
    private int _scenarioIndex;
    private readonly SimulationScenario[] _scenarios = new[]
    {
        SimulationScenario.NormalSitting,
        SimulationScenario.PressureBuildupAlert,
        SimulationScenario.WeightShiftingRelief,
        SimulationScenario.SequentialDemo
    };

    // Author: SID:2412494 - Weekly stats for dashboard
    private int _sessionsThisWeek;
    private int _sessionsTotal;
    private int _alertsThisWeek;
    private int _alertsLastWeek;

    // Inspirational quotes array (placeholder for AI-generated insights)
    private readonly string[] inspirationalQuotes = new[]
    {
        "Every step towards better health is a victory worth celebrating.",
        "Your commitment to monitoring your health today shapes a healthier tomorrow.",
        "Small, consistent actions lead to remarkable transformations.",
        "Wellness is a journey, not a destination. You're on the right path.",
        "Taking care of yourself is the most important investment you can make.",
        "Progress, not perfection. Every day is a new opportunity.",
        "Your health data tells a story of resilience and dedication.",
        "Prevention is the best medicine, and you're taking charge.",
        "Consistency is the bridge between goals and accomplishment.",
        "Trust the process. Your efforts are making a difference."
    };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userName = authState.User.Identity?.Name ?? "Unknown";

        // Get user ID for device connection
        var userIdClaim = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
        if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var userId))
        {
            _userId = userId;
        }

        // Load config values for JS renderer
        _minValue = Configuration.GetValue("PressureThresholds:MinValue", 0);
        _maxValue = Configuration.GetValue("PressureThresholds:MaxValue", 255);

        // Select a random inspirational quote for the weekly summary
        var random = new Random();
        randomQuote = inspirationalQuotes[random.Next(inspirationalQuotes.Length)];

        // Author: SID:2412494 - Load patient-specific settings (Story #10)
        if (_userId != Guid.Empty)
        {
            _patientSettings = await PatientSettingsService.GetSettingsAsync(_userId);

            // Author: SID:2412494 - Load weekly stats for dashboard
            await LoadWeeklyStatsAsync();
        }

        // Check if device already exists (e.g., from previous session)
        var existingDevice = DeviceManager.TryGetDevice(_userId);
        if (existingDevice != null && existingDevice.Status == DeviceStatus.Running)
        {
            _device = existingDevice;
            _isConnected = true;
            SubscribeToDevice();
        }

        // Author: SID:2412494 - Initialize SignalR connection for clinician notifications (Story #28)
        await InitializeAlertHubAsync();
    }

    // Author: SID:2412494 - Load weekly stats from database
    private async Task LoadWeeklyStatsAsync()
    {
        try
        {
            var now = DateTime.UtcNow;
            var weekAgo = now.AddDays(-7);
            var twoWeeksAgo = now.AddDays(-14);

            // Get session counts
            _sessionsTotal = await PressureDataService.GetSessionCountAsync(_userId);
            _sessionsThisWeek = await PressureDataService.GetSessionCountAsync(_userId, weekAgo);

            // Get alert counts (flagged sessions as proxy for alerts)
            _alertsThisWeek = await PressureDataService.GetFlaggedSessionCountAsync(_userId, weekAgo);
            _alertsLastWeek = await PressureDataService.GetFlaggedSessionCountAsync(_userId, twoWeeksAgo)
                             - _alertsThisWeek;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load weekly stats: {ex.Message}");
        }
    }

    // Author: SID:2412494 - Initialize AlertHub SignalR connection (Story #28)
    private async Task InitializeAlertHubAsync()
    {
        try
        {
            _alertHubConnection = new HubConnectionBuilder()
                .WithUrl(NavigationManager.ToAbsoluteUri("/alerthub"))
                .WithAutomaticReconnect()
                .Build();

            // Handle clinician direct notifications (Story #28)
            _alertHubConnection.On<object>("ReceiveClinicianNotification", async (data) =>
            {
                var message = data?.GetType().GetProperty("Message")?.GetValue(data)?.ToString();
                if (!string.IsNullOrEmpty(message))
                {
                    _clinicianMessage = message;
                    await InvokeAsync(StateHasChanged);

                    // Show browser notification
                    if (_notificationsEnabled)
                    {
                        await NotificationService.ShowNotificationAsync(
                            title: "Message from your clinician",
                            body: message,
                            tag: "clinician-message",
                            requireInteraction: true);
                    }
                }
            });

            // Handle pressure alerts from hub (backup to local detection)
            _alertHubConnection.On<PressureAlertData>("ReceivePressureAlert", async (alert) =>
            {
                // This is handled locally, but hub can provide additional alerts
                await InvokeAsync(StateHasChanged);
            });

            // Handle equipment fault alerts
            _alertHubConnection.On<EquipmentFaultData>("ReceiveEquipmentFault", async (fault) =>
            {
                await InvokeAsync(StateHasChanged);
            });

            await _alertHubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to connect to AlertHub: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Author: SID:2412494 - Check notification permissions on first render (Story #10)
        if (firstRender)
        {
            await CheckNotificationPermissionsAsync();
        }

        // Initialize canvas after render if connected but canvas not yet initialized
        // This handles the case where user navigates away and back while device is running
        if (_isConnected && !_isCanvasInitialized)
        {
            await InitializeCanvasAsync();
        }
    }

    // Author: SID:2412494 - Check and handle notification permissions (Story #10)
    private async Task CheckNotificationPermissionsAsync()
    {
        try
        {
            var isSupported = await NotificationService.IsNotificationSupportedAsync();
            if (!isSupported)
            {
                return;
            }

            var permission = await NotificationService.GetPermissionAsync();

            if (permission == "granted")
            {
                _notificationsEnabled = true;
            }
            else if (permission == "default")
            {
                // User hasn't been asked yet - show the banner
                _showNotificationBanner = true;
                StateHasChanged();
            }
            // If denied, don't show banner - user made their choice
        }
        catch
        {
            // Notifications not available
        }
    }

    // Author: SID:2412494 - Request notification permission from user (Story #10)
    private async Task RequestNotificationPermissionAsync()
    {
        try
        {
            var result = await NotificationService.RequestPermissionAsync();
            _notificationsEnabled = result == "granted";
            _showNotificationBanner = false;
            StateHasChanged();
        }
        catch
        {
            _showNotificationBanner = false;
            StateHasChanged();
        }
    }

    // Author: SID:2412494 - Dismiss notification banner
    private void DismissNotificationBanner()
    {
        _showNotificationBanner = false;
    }

    // Author: SID:2412494 - Dismiss clinician message toast (Story #28)
    private void DismissClinicianMessage()
    {
        _clinicianMessage = null;
    }

    private async Task ConnectDeviceAsync()
    {
        if (_isConnecting || _userId == Guid.Empty)
            return;

        try
        {
            _isConnecting = true;
            StateHasChanged();

            // Get or create mock device for this patient
            _device = await DeviceManager.GetOrCreateDeviceForPatientAsync(_userId);
            _isConnected = true;

            // Force re-render to show canvas
            StateHasChanged();

            // Small delay to ensure canvas is in DOM
            await Task.Delay(50);

            // Initialize the JS heatmap renderer
            await InitializeCanvasAsync();

            // Subscribe to device events
            SubscribeToDevice();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error connecting device: {ex.Message}");
            _isConnected = false;
        }
        finally
        {
            _isConnecting = false;
            StateHasChanged();
        }
    }

    private async Task InitializeCanvasAsync()
    {
        if (_isCanvasInitialized)
            return;

        await JS.InvokeVoidAsync("heatmapRenderer.initialize", _canvasId, _minValue, _maxValue, 10);
        _isCanvasInitialized = true;
    }

    private void SubscribeToDevice()
    {
        if (_device == null)
            return;

        _device.OnFrameGenerated += OnFrameGenerated;
        _device.OnAlertDetected += OnAlertDetected;
    }

    private void UnsubscribeFromDevice()
    {
        if (_device == null)
            return;

        _device.OnFrameGenerated -= OnFrameGenerated;
        _device.OnAlertDetected -= OnAlertDetected;
    }

    private void OnFrameGenerated(HeatmapFrame frame)
    {
        _currentFrame = frame;

        // Render to canvas via JS interop
        InvokeAsync(async () =>
        {
            try
            {
                if (_isCanvasInitialized)
                {
                    await JS.InvokeVoidAsync("heatmapRenderer.renderGradient", _canvasId, frame.PressureData);
                }
                StateHasChanged();
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected - ignore
            }
        });
    }

    // Author: SID:2412494 - Updated to trigger browser notifications (Stories #10, #18)
    private void OnAlertDetected(MedicalAlert alerts, HeatmapFrame frame)
    {
        var previousAlerts = _currentAlerts;
        var previousFaults = _currentFaults;

        _currentAlerts = alerts;
        _currentFaults = frame.ActiveFaults;

        InvokeAsync(async () =>
        {
            // Only trigger notifications for NEW alerts (not already active)
            if (_notificationsEnabled)
            {
                // Pressure alert notification (Story #10)
                if (alerts.HasFlag(MedicalAlert.ThresholdBreach) &&
                    !previousAlerts.HasFlag(MedicalAlert.ThresholdBreach))
                {
                    await TriggerPressureAlertNotificationAsync(frame);
                }

                // Sustained pressure notification (more urgent)
                if (alerts.HasFlag(MedicalAlert.SustainedPressure) &&
                    !previousAlerts.HasFlag(MedicalAlert.SustainedPressure))
                {
                    await NotificationService.ShowNotificationAsync(
                        title: "Sustained High Pressure!",
                        body: "Pressure has been elevated for an extended period. Please reposition immediately.",
                        tag: "sustained-pressure",
                        requireInteraction: true);
                }

                // Equipment fault notification (Story #18)
                if (frame.ActiveFaults != DeviceFault.None &&
                    frame.ActiveFaults != previousFaults)
                {
                    await TriggerEquipmentFaultNotificationAsync(frame.ActiveFaults);
                }
            }

            StateHasChanged();
        });
    }

    // Author: SID:2412494 - Trigger browser notification for pressure alert (Story #10)
    private async Task TriggerPressureAlertNotificationAsync(HeatmapFrame frame)
    {
        if (_patientSettings == null) return;

        var evaluation = await AlertService.EvaluateFrameAsync(frame);

        if (evaluation.ShouldNotifyPatient)
        {
            var notification = AlertService.CreatePressureAlertNotification(evaluation);

            await NotificationService.ShowNotificationAsync(
                title: notification.Title,
                body: notification.Body,
                icon: notification.Icon,
                tag: notification.Tag,
                requireInteraction: notification.RequireInteraction);

            // Also notify assigned clinicians via SignalR (Story #7)
            if (_alertHubConnection?.State == HubConnectionState.Connected)
            {
                try
                {
                    await _alertHubConnection.SendAsync("SendPressureAlert", _userId, new PressureAlertData
                    {
                        PeakPressure = frame.PeakPressure,
                        Threshold = _patientSettings.HighPressureThreshold,
                        Severity = evaluation.BreachSeverity,
                        Message = notification.Body,
                        RequireInteraction = notification.RequireInteraction
                    });
                }
                catch
                {
                    // Hub connection issue - notification still shown locally
                }
            }
        }
    }

    // Author: SID:2412494 - Trigger browser notification for equipment fault (Story #18)
    private async Task TriggerEquipmentFaultNotificationAsync(DeviceFault faults)
    {
        var evaluation = AlertService.EvaluateEquipmentFault(_userId, faults);

        if (evaluation.ShouldNotifyPatient)
        {
            var notification = AlertService.CreateEquipmentFaultNotification(evaluation);

            await NotificationService.ShowNotificationAsync(
                title: notification.Title,
                body: notification.Body,
                icon: notification.Icon,
                tag: notification.Tag,
                requireInteraction: notification.RequireInteraction);

            // Notify assigned clinicians (Story #7)
            if (_alertHubConnection?.State == HubConnectionState.Connected)
            {
                try
                {
                    await _alertHubConnection.SendAsync("SendEquipmentFaultAlert", _userId, new EquipmentFaultData
                    {
                        FaultType = faults.ToString(),
                        Description = notification.Body,
                        IsCritical = notification.RequireInteraction
                    });
                }
                catch
                {
                    // Hub connection issue
                }
            }
        }
    }

    private void CycleScenario()
    {
        if (_device == null)
            return;

        _scenarioIndex = (_scenarioIndex + 1) % _scenarios.Length;
        _device.SetScenario(_scenarios[_scenarioIndex]);
        StateHasChanged();
    }

    private void InjectRandomFault()
    {
        if (_device == null)
            return;

        var faults = new[]
        {
            DeviceFault.DeadPixels,
            DeviceFault.PartialDataLoss,
            DeviceFault.CalibrationDrift,
            DeviceFault.ElectricalNoise
        };

        var random = new Random();
        var fault = faults[random.Next(faults.Length)];

        _device.InjectFault(fault, TimeSpan.FromSeconds(3));
        StateHasChanged();
    }

    private async Task DisconnectDeviceAsync()
    {
        if (_device == null || _userId == Guid.Empty)
            return;

        UnsubscribeFromDevice();

        // Dispose the device via manager
        await DeviceManager.DisposeDeviceAsync(_userId);

        // Clean up canvas
        if (_isCanvasInitialized)
        {
            try
            {
                await JS.InvokeVoidAsync("heatmapRenderer.dispose", _canvasId);
            }
            catch (JSDisconnectedException)
            {
                // Ignore
            }
            _isCanvasInitialized = false;
        }

        _device = null;
        _currentFrame = null;
        _isConnected = false;
        _currentAlerts = MedicalAlert.None;

        StateHasChanged();
    }

    // Helper methods for UI state
    // Author: SID:2412494 - Updated to use patient-specific thresholds (Story #10)
    private string GetPeakPressureClass()
    {
        if (_currentFrame == null)
            return "";

        // Use patient-specific thresholds if available, otherwise fall back to config
        var highThreshold = _patientSettings?.HighPressureThreshold
            ?? Configuration.GetValue("PressureThresholds:DefaultHighThreshold", 200);
        if (_currentFrame.PeakPressure >= highThreshold)
            return "pressure-high";

        var lowThreshold = _patientSettings?.LowPressureThreshold
            ?? Configuration.GetValue("PressureThresholds:DefaultLowThreshold", 50);
        if (_currentFrame.PeakPressure >= lowThreshold)
            return "pressure-medium";

        return "pressure-low";
    }

    // Author: SID:2412494 - Equipment fault description (Story #18)
    private string GetFaultDescription()
    {
        var descriptions = new List<string>();

        if (_currentFaults.HasFlag(DeviceFault.Disconnected))
            descriptions.Add("Device disconnected");
        if (_currentFaults.HasFlag(DeviceFault.Saturation))
            descriptions.Add("Sensor saturated");
        if (_currentFaults.HasFlag(DeviceFault.DeadPixels))
            descriptions.Add("Dead pixels detected");
        if (_currentFaults.HasFlag(DeviceFault.PartialDataLoss))
            descriptions.Add("Partial data loss");
        if (_currentFaults.HasFlag(DeviceFault.CalibrationDrift))
            descriptions.Add("Calibration drift");
        if (_currentFaults.HasFlag(DeviceFault.ElectricalNoise))
            descriptions.Add("Electrical noise");

        return descriptions.Count > 0 ? string.Join(", ", descriptions) : "Unknown issue";
    }

    // Author: SID:2412494 - Equipment fault advice (Story #18)
    private string GetFaultAdvice()
    {
        if (_currentFaults.HasFlag(DeviceFault.Disconnected))
            return "Check device connection and try reconnecting.";
        if (_currentFaults.HasFlag(DeviceFault.Saturation))
            return "Sensor readings are at maximum. Contact support if this persists.";
        if (_currentFaults.HasFlag(DeviceFault.CalibrationDrift))
            return "Sensor may need recalibration. Contact your clinician.";
        if (_currentFaults.HasFlag(DeviceFault.DeadPixels) || _currentFaults.HasFlag(DeviceFault.PartialDataLoss))
            return "Some sensor areas may not be reading correctly.";
        if (_currentFaults.HasFlag(DeviceFault.ElectricalNoise))
            return "Readings may be temporarily affected by interference.";

        return "If the issue persists, contact your clinician.";
    }

    private string GetAlertCardClass()
    {
        if (_currentAlerts.HasFlag(MedicalAlert.HighPressure) ||
            _currentAlerts.HasFlag(MedicalAlert.SustainedPressure))
            return "alert-active";

        if (_currentAlerts.HasFlag(MedicalAlert.PositioningWarning))
            return "alert-warning";

        return "";
    }

    private string GetAlertIcon()
    {
        if (_currentAlerts.HasFlag(MedicalAlert.HighPressure) ||
            _currentAlerts.HasFlag(MedicalAlert.SustainedPressure))
            return "üö®";

        if (_currentAlerts.HasFlag(MedicalAlert.PositioningWarning))
            return "‚ö†Ô∏è";

        return "‚úì";
    }

    private string GetAlertTitle()
    {
        if (_currentAlerts.HasFlag(MedicalAlert.SustainedPressure))
            return "Sustained High Pressure!";

        if (_currentAlerts.HasFlag(MedicalAlert.HighPressure))
            return "High Pressure Detected";

        if (_currentAlerts.HasFlag(MedicalAlert.PositioningWarning))
            return "Positioning Warning";

        return _isConnected ? "All Clear" : "High Pressure Alert";
    }

    private string GetAlertMessage()
    {
        if (_currentAlerts.HasFlag(MedicalAlert.SustainedPressure))
            return "Pressure has been elevated for an extended period. Please reposition.";

        if (_currentAlerts.HasFlag(MedicalAlert.HighPressure))
            return $"Peak pressure: {_currentFrame?.PeakPressure ?? 0}. Consider repositioning.";

        if (_currentAlerts.HasFlag(MedicalAlert.PositioningWarning))
            return "Uneven weight distribution detected.";

        return _isConnected ? "No pressure alerts at this time." : "Will notify when alert system is configured";
    }

    // Author: SID:2412494 - Compare alerts to last week
    private string GetAlertComparisonText()
    {
        if (_alertsLastWeek == 0 && _alertsThisWeek == 0)
            return "No alerts";

        var diff = _alertsThisWeek - _alertsLastWeek;
        if (diff > 0)
            return $"Up {diff} from last week";
        if (diff < 0)
            return $"Down {Math.Abs(diff)} from last week";

        return "Same as last week";
    }

    public async ValueTask DisposeAsync()
    {
        UnsubscribeFromDevice();

        if (_isCanvasInitialized)
        {
            try
            {
                await JS.InvokeVoidAsync("heatmapRenderer.dispose", _canvasId);
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected - ignore
            }
            // Reset flag so canvas re-initializes when component is recreated
            _isCanvasInitialized = false;
        }

        // Author: SID:2412494 - Clean up AlertHub connection
        if (_alertHubConnection != null)
        {
            await _alertHubConnection.DisposeAsync();
        }

        // Note: We don't dispose the device here because it's managed by MockDeviceManager
        // and should persist while the user is logged in
    }
}
