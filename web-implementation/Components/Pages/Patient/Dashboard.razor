@page "/patient/dashboard"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Patient")]
@using GrapheneTrace.Web.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@inject AuthenticationStateProvider AuthStateProvider
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager Navigation

@*
    Patient Dashboard Page
    Author: SID:2412494
    Route: /patient/dashboard

    Purpose: Main dashboard for patient users.

    Authorization: Restricted to Patient role only using [Authorize(Roles = "Patient")].
    Users without the Patient role will receive a 403 Forbidden and be redirected to /access-denied.

    Current Implementation: Simple placeholder for testing authentication flow.
    Production TODO: Add patient-specific features (personal pressure data, alerts, settings, etc.)
*@

<div style="padding: 2rem;">
    <div style="max-width: 64rem; margin: 0 auto;">
        <h1 style="font-size: 2rem; font-weight: bold; margin-bottom: 1rem;">
            Patient Dashboard
        </h1>

        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem;">
            <p style="margin-bottom: 0.5rem;">
                <strong>Welcome, @userName!</strong>
            </p>
            <p style="color: #6b7280; margin-bottom: 0.5rem;">
                Role: <strong>Patient</strong>
            </p>
            <p style="color: #6b7280;">
                View your pressure data and manage your settings.
            </p>
        </div>

        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem;">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">
                Quick Actions
            </h2>
            <p style="color: #6b7280; margin-bottom: 1rem;">
                Patient features coming soon: Pressure data visualization, alert settings, personal information, etc.
            </p>
            <button @onclick="HandleLogout"
                    style="background: #dc2626; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500;">
                Logout
            </button>
        </div>
    </div>
</div>

@code {
    private string userName = "";

    /// <summary>
    /// Component initialization: loads user information from authentication state.
    /// Author: SID:2412494
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userName = authState.User.Identity?.Name ?? "Unknown";

        // Role verification is handled by [Authorize(Roles = "Patient")] attribute
        // Non-patient users are automatically redirected to /access-denied
    }

    /// <summary>
    /// Handles user logout using ASP.NET Core Identity.
    /// Author: SID:2412494
    /// </summary>
    private async Task HandleLogout()
    {
        await SignInManager.SignOutAsync();
        Navigation.NavigateTo("/login", forceLoad: true);
    }
}
