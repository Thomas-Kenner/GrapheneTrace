@page "/admin/users"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]
@using GrapheneTrace.Web.Models
@using GrapheneTrace.Web.Components.Layout

<div class="admin-container">
    <AdminHeader />

    <div class="admin-content">
        <div class="page-header">
            <h2 class="section-title">Users Management</h2>
            <button class="btn btn-primary" @onclick="() => showCreateModal = true">
                + Create New User
            </button>
        </div>

        @if (isLoading)
        {
            <p>Loading users...</p>
        }
        else if (users == null || users.Count == 0)
        {
            <p class="no-data-message">No users found</p>
        }
        else
        {
            <div class="users-table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (filteredUsers != null)
                        {
                            @foreach (var user in filteredUsers)
                            {
                                <tr>
                                @* Author: SID:2412494 - Made clinician names clickable to open assignment modal *@
                                <td>
                                    @if (user.UserType == "clinician")
                                    {
                                        <button class="btn-link" @onclick="() => OpenAssignmentModal(user)">
                                            @user.FullName
                                        </button>
                                    }
                                    else
                                    {
                                        @user.FullName
                                    }
                                </td>
                                <td>@user.Email</td>
                                <td>
                                    <span class="user-type-badge" style="background-color: @GetUserTypeColor(user.UserType)">
                                        @user.UserType
                                    </span>
                                </td>
                                <td>
                                    @if (user.DeactivatedAt == null)
                                    {
                                        <span class="status-badge status-active">Active</span>
                                    }
                                    else
                                    {
                                        <span class="status-badge status-inactive">Inactive</span>
                                    }
                                </td>
                                <td>@user.Id.ToString().Substring(0, 8)...</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action btn-edit" @onclick="() => EditUser(user)">Edit</button>
                                        <button class="btn-action btn-delete"
                                                @onclick="() => DeleteUser(user.Id)"
                                                disabled="@(user.DeactivatedAt != null)">
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    <div class="admin-footer">
        <p>Contact us · About · FAQ</p>
    </div>
</div>

@if (showCreateModal)
{
    <div class="modal-overlay" @onclick="() => showCreateModal = false">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Create New User</h3>
                <button class="modal-close" @onclick="() => showCreateModal = false">×</button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-input" @bind="newUser.FirstName" placeholder="John" />
                </div>

                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-input" @bind="newUser.LastName" placeholder="Doe" />
                </div>

                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" @bind="newUser.Email" placeholder="john@example.com" />
                </div>

                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" @bind="newUserPassword" placeholder="Enter password" />
                    <p class="password-hint">
                        Min 12 chars, uppercase, lowercase, number, special char
                    </p>
                </div>

                <div class="form-group">
                    <label class="form-label">User Type</label>
                    <select class="form-input" @bind="newUser.UserType">
                        <option value="">Select user type</option>
                        <option value="admin">Admin</option>
                        <option value="clinician">Clinician</option>
                        <option value="patient">Patient</option>
                    </select>
                </div>

                @if (!string.IsNullOrEmpty(createMessage))
                {
                    <div class="alert @(createSuccess ? "alert-success" : "alert-error")">
                        @createMessage
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="() => showCreateModal = false">Cancel</button>
                <button class="btn btn-primary" @onclick="CreateUser" disabled="@(string.IsNullOrEmpty(newUser.Email) || string.IsNullOrEmpty(newUserPassword))">
                    Create User
                </button>
            </div>
        </div>
    </div>
}

@if (showEditModal && editingUser != null)
{
    <div class="modal-overlay" @onclick="() => showEditModal = false">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Edit User</h3>
                <button class="modal-close" @onclick="() => showEditModal = false">×</button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-input" @bind="editingUser.FirstName" />
                </div>

                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-input" @bind="editingUser.LastName" />
                </div>

                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" @bind="editingUser.Email" />
                </div>

                <div class="form-group">
                    <label class="form-label">User Type</label>
                    <select class="form-input" @bind="editingUser.UserType">
                        <option value="admin">Admin</option>
                        <option value="clinician">Clinician</option>
                        <option value="patient">Patient</option>
                    </select>
                </div>

                @if (!string.IsNullOrEmpty(editMessage))
                {
                    <div class="alert @(editSuccess ? "alert-success" : "alert-error")">
                        @editMessage
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="() => showEditModal = false">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveUser">Save Changes</button>
            </div>
        </div>
    </div>
}

@*
    PATIENT ASSIGNMENT MODAL
    Author: SID:2412494

    Purpose:
    Modal dialog for assigning patients to clinicians. Displays all active patients
    with assigned patients at the top, allowing admins to toggle assignment status.
*@
@if (showAssignmentModal && selectedClinicianForAssignment != null)
{
    <div class="modal-overlay" @onclick="CloseAssignmentModal">
        <div class="modal-content modal-wide" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Assign Patients to @selectedClinicianForAssignment.FullName</h3>
                <button class="modal-close" @onclick="CloseAssignmentModal">×</button>
            </div>

            <div class="modal-body">
                @if (isLoadingAssignments)
                {
                    <p>Loading patients...</p>
                }
                else if (allPatients == null || allPatients.Count == 0)
                {
                    <p style="color: var(--muted-foreground);">No patients found in the system.</p>
                }
                else
                {
                    <p style="margin-bottom: 1rem; color: var(--muted-foreground);">
                        Select patients to assign to this clinician. Assigned patients can be viewed
                        and monitored by the clinician.
                    </p>

                    @if (!string.IsNullOrEmpty(assignmentMessage))
                    {
                        <div class="alert" style="background-color: @(assignmentSuccess ? "#d4edda" : "#f8d7da"); color: @(assignmentSuccess ? "#155724" : "#721c24"); padding: 0.75rem; border-radius: var(--radius); margin-bottom: 1rem;">
                            @assignmentMessage
                        </div>
                    }

                    <div class="patient-assignment-list">
                        @* Show assigned patients first *@
                        @foreach (var patient in allPatients.OrderByDescending(p => assignedPatientIds.Contains(p.Id)).ThenBy(p => p.LastName).ThenBy(p => p.FirstName))
                        {
                            var isAssigned = assignedPatientIds.Contains(patient.Id);
                            <div class="patient-assignment-item @(isAssigned ? "assigned" : "")">
                                <label class="patient-checkbox-label">
                                    <input type="checkbox"
                                           checked="@isAssigned"
                                           disabled="@isProcessingAssignment"
                                           @onchange="() => TogglePatientAssignment(patient.Id, !isAssigned)" />
                                    <span class="patient-info">
                                        <span class="patient-name">@patient.FullName</span>
                                        <span class="patient-email">@patient.Email</span>
                                    </span>
                                    @if (isAssigned)
                                    {
                                        <span class="assignment-badge">Assigned</span>
                                    }
                                </label>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="CloseAssignmentModal">Close</button>
            </div>
        </div>
    </div>
}
