@page "/admin/users"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]
@using GrapheneTrace.Web.Models
@using GrapheneTrace.Web.Components.Layout

<div class="admin-container">
    <AdminHeader />

    <div class="admin-content">
        <div class="page-header">
            <h2 class="section-title">Users Management</h2>
            <button class="btn btn-primary" @onclick="() => showCreateModal = true">
                + Create New User
            </button>
        </div>

        @* Author: SID:2412494 - Added search input to filter users by name or email *@
        <div style="margin-bottom: 1rem;">
            <input type="text"
                   class="form-input"
                   placeholder="Search users by name or email..."
                   value="@searchQuery"
                   @oninput="OnSearchChange"
                   style="max-width: 400px;" />
        </div>

        @if (isLoading)
        {
            <p>Loading users...</p>
        }
        else if (users == null || users.Count == 0)
        {
            <p class="no-data-message">No users found</p>
        }
        else
        {
            <div class="users-table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (filteredUsers != null)
                        {
                            @foreach (var user in filteredUsers)
                            {
                                <tr>
                                <td>@user.FullName</td>
                                <td>@user.Email</td>
                                <td>
                                    <span class="user-type-badge" style="background-color: @GetUserTypeColor(user.UserType)">
                                        @user.UserType
                                    </span>
                                </td>
                                <td>
                                    @if (user.DeactivatedAt == null)
                                    {
                                        <span class="status-badge status-active">Active</span>
                                    }
                                    else
                                    {
                                        <span class="status-badge status-inactive">Inactive</span>
                                    }
                                </td>
                                <td>@user.Id.ToString().Substring(0, 8)...</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-action btn-edit" @onclick="() => EditUser(user)">Edit</button>
                                        <button class="btn-action btn-delete"
                                                @onclick="() => DeleteUser(user.Id)"
                                                disabled="@(user.DeactivatedAt != null)">
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    <div class="admin-footer">
        <p>Contact us · About · FAQ</p>
    </div>
</div>

@if (showCreateModal)
{
    <div class="modal-overlay" @onclick="() => showCreateModal = false">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Create New User</h3>
                <button class="modal-close" @onclick="() => showCreateModal = false">×</button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-input" @bind="newUser.FirstName" placeholder="John" />
                </div>

                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-input" @bind="newUser.LastName" placeholder="Doe" />
                </div>

                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" @bind="newUser.Email" placeholder="john@example.com" />
                </div>

                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" @bind="newUserPassword" placeholder="Enter password" />
                    <p class="password-hint">
                        Min 12 chars, uppercase, lowercase, number, special char
                    </p>
                </div>

                <div class="form-group">
                    <label class="form-label">User Type</label>
                    <select class="form-input" @bind="newUser.UserType">
                        <option value="">Select user type</option>
                        <option value="admin">Admin</option>
                        <option value="clinician">Clinician</option>
                        <option value="patient">Patient</option>
                    </select>
                </div>

                @if (!string.IsNullOrEmpty(createMessage))
                {
                    <div class="alert @(createSuccess ? "alert-success" : "alert-error")">
                        @createMessage
                    </div>
                }
            </div>

            @* Author: SID:2412494 - Added UserType to disabled check to prevent accounts without roles *@
            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="() => showCreateModal = false">Cancel</button>
                <button class="btn btn-primary" @onclick="CreateUser" disabled="@(string.IsNullOrEmpty(newUser.Email) || string.IsNullOrEmpty(newUserPassword) || string.IsNullOrEmpty(newUser.UserType))">
                    Create User
                </button>
            </div>
        </div>
    </div>
}

@if (showEditModal && editingUser != null)
{
    <div class="modal-overlay" @onclick="() => showEditModal = false">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Edit User</h3>
                <button class="modal-close" @onclick="() => showEditModal = false">×</button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-input" @bind="editingUser.FirstName" />
                </div>

                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-input" @bind="editingUser.LastName" />
                </div>

                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" @bind="editingUser.Email" />
                </div>

                <div class="form-group">
                    <label class="form-label">User Type</label>
                    <select class="form-input" @bind="editingUser.UserType">
                        <option value="admin">Admin</option>
                        <option value="clinician">Clinician</option>
                        <option value="patient">Patient</option>
                    </select>
                </div>

                @if (!string.IsNullOrEmpty(editMessage))
                {
                    <div class="alert @(editSuccess ? "alert-success" : "alert-error")">
                        @editMessage
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline" @onclick="() => showEditModal = false">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveUser">Save Changes</button>
            </div>
        </div>
    </div>
}
