@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

@*
    PATIENT HEADER COMPONENT
    Authors: SID:2402513 (original design), SID:2412494 (auth integration)
    Updated: 2402513 - Added IDisposable implementation and dynamic subtitle

    Purpose:
    Unified header for all patient pages with navigation tabs and user controls.
    Combines the visual design from dashboard-impl with authentication features from main.

    How it works:
    - header-left: App branding with simplified "Sensore GrapheneTrace" and dynamic subtitle
    - patient-nav: Clean navigation tabs for patient sections
    - header-right: Notifications, settings quick-access, and sign out
    - Uses authentication state for user info

    Why it was done this way:
    - Merges best of both implementations: clean UI + proper auth
    - Maintains consistent navigation pattern
    - Provides easy access to key functions
*@
@implements IDisposable

<header class="patient-header">
    <div class="header-left">
        <span class="header-brand">Sensore GrapheneTrace</span>
        <span class="header-subtitle">@GetSubtitle()</span>
    </div>
    <div class="header-right">
        <button class="icon-btn" title="Notifications">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
        </button>
        <button class="icon-btn" title="Settings" @onclick="GoToSettings">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6"></path>
                <path d="M21 12h-6m-6 0H3"></path>
            </svg>
        </button>
        <form method="post" action="/account/logout" style="display: inline; margin: 0;">
            <button type="submit" class="btn-signout">Sign Out</button>
        </form>
    </div>
</header>

<nav class="patient-nav">
    <button class="nav-tab @GetActiveClass("dashboard")" @onclick="GoToDashboard">Dashboard</button>
    <button class="nav-tab @GetActiveClass("pressure-data")" @onclick="GoToPressureData">Pressure Data</button>
    <button class="nav-tab @GetActiveClass("sessions")" @onclick="GoToSessions">Sessions</button>
    <button class="nav-tab @GetActiveClass("settings")" @onclick="GoToSettings">Settings</button>
    <button class="nav-tab @GetActiveClass("support")" @onclick="GoToSupport">Support</button>
</nav>

@code {
    private string currentPath = "";
    private string userName = "";
    private string userEmail = "";

    protected override async Task OnInitializedAsync()
    {
        // Get authentication state for future use if needed
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userName = authState.User.Identity?.Name ?? "Unknown";

        // Extract email from claims if available
        var emailClaim = authState.User.FindFirst("email");
        userEmail = emailClaim?.Value ?? authState.User.Identity?.Name ?? "patient@graphene.com";

        currentPath = new Uri(Navigation.Uri).AbsolutePath;
        Navigation.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        currentPath = new Uri(e.Location).AbsolutePath;
        StateHasChanged();
    }

    private string GetActiveClass(string page)
    {
        return currentPath.Contains(page, StringComparison.OrdinalIgnoreCase) ? "active" : "";
    }

    private void GoToDashboard() => Navigation.NavigateTo("/patient/dashboard");
    private void GoToPressureData() => Navigation.NavigateTo("/patient/pressure-data");
    private void GoToSessions() => Navigation.NavigateTo("/patient/sessions");
    private void GoToSettings() => Navigation.NavigateTo("/patient/settings");
    private void GoToSupport() => Navigation.NavigateTo("/patient/support");

    /// <summary>
    /// Gets the subtitle text based on the current page.
    /// Author: 2402513
    /// Updated: 2402513 - Added dynamic subtitle based on current page route
    /// </summary>
    private string GetSubtitle()
    {
        if (currentPath.Contains("/pressure-data", StringComparison.OrdinalIgnoreCase))
        {
            return "Patient Pressure Data";
        }
        else if (currentPath.Contains("/sessions", StringComparison.OrdinalIgnoreCase))
        {
            return "Patient Sessions";
        }
        else if (currentPath.Contains("/settings", StringComparison.OrdinalIgnoreCase))
        {
            return "Patient Settings";
        }
        else if (currentPath.Contains("/support", StringComparison.OrdinalIgnoreCase))
        {
            return "Patient Support";
        }
        else
        {
            return "Patient Dashboard";
        }
    }

    /// <summary>
    /// Disposes the component and unsubscribes from navigation events.
    /// Author: 2402513
    /// Updated: 2402513 - Added proper IDisposable implementation
    /// </summary>
    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
