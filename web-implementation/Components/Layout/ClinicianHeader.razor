@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using GrapheneTrace.Web.Services
@using GrapheneTrace.Web.Models
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS

@*
    CLINICIAN HEADER COMPONENT
    Author: 2402513

    Purpose:
    Header for clinician pages with specific navigation and user controls.
    Includes patient search functionality.

    How it works:
    - header-left: App branding
    - header-center: Navigation tabs (Dashboard, Settings, Support)
    - header-right: Search bar and User profile dropdown
*@

<header class="admin-header-consolidated" @ref="headerRef">
    <div style="max-width: 1400px; margin: 0 auto; width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 1rem 2rem;">
        <div class="header-left">
            <a class="header-brand-link" href="/clinician/dashboard">
                <span class="header-brand">SensorGrapheneTrace</span>
            </a>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab @GetNavClass("dashboard")" @onclick="GoToDashboard">Dashboard</button>
            <button class="nav-tab @GetNavClass("settings")" @onclick="GoToSettings">Settings</button>
            <button class="nav-tab @GetNavClass("support")" @onclick="GoToSupport">Support/Chat</button>
        </div>

        <div class="header-right">
            <div class="search-container" @onclick:stopPropagation="true">
                <input
                    type="text"
                    class="search-input"
                    placeholder="Search patients..."
                    @bind="searchQuery"
                    @oninput="OnSearchInput"
                />
                @if (searchResults.Count > 0 && !string.IsNullOrWhiteSpace(searchQuery))
                {
                    <div class="search-results">
                        @foreach (var patient in searchResults.Take(5))
                        {
                            <div class="search-result-item" @onclick="() => SelectPatient(patient)">
                                <div class="result-name">@patient.FullName</div>
                                <div class="result-email">Condition: @patient.Condition</div>
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="profile-section" @onclick:stopPropagation="true">
                <span class="user-email">@userEmail</span>
                <div class="profile-dropdown">
                    <button class="user-avatar" type="button" title="User menu" @onclick="ToggleMenu">
                    </button>
                    @if (isMenuOpen)
                    {
                        <div class="profile-menu">
                            <div class="profile-menu-header">
                                <p class="profile-name">@userName</p>
                                <p class="profile-email">@userEmail</p>
                            </div>
                            <form method="post" action="/account/logout" style="margin: 0;">
                                <button type="submit" class="profile-menu-item">
                                    <span class="bi bi-box-arrow-right"></span> Sign Out
                                </button>
                            </form>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</header>

@implements IDisposable
@inject GrapheneTrace.Web.Services.UserManagementService UserManagementService

@code {
    private bool isMenuOpen = false;
    private string userName = "";
    private string userEmail = "";
    private string currentPath = "";
    private string searchQuery = "";
    private List<ApplicationUser> searchResults = new();
    private ElementReference headerRef;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userName = authState.User.Identity?.Name ?? "Unknown";

        // Extract email from claims if available
        var emailClaim = authState.User.FindFirst("email");
        userEmail = emailClaim?.Value ?? authState.User.Identity?.Name ?? "clinician@graphene.com";

        currentPath = new Uri(Navigation.Uri).AbsolutePath;
        Navigation.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentPath = new Uri(e.Location).AbsolutePath;
        StateHasChanged();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("addClickOutsideListener", headerRef, DotNetObjectReference.Create(this));
        }
    }

    [JSInvokable]
    public void CloseMenu()
    {
        if (isMenuOpen)
        {
            isMenuOpen = false;
            StateHasChanged();
        }
        
        if (searchResults.Count > 0)
        {
            searchResults.Clear();
            StateHasChanged();
        }
    }

    private void ToggleMenu()
    {
        isMenuOpen = !isMenuOpen;
    }

    private string GetNavClass(string page)
    {
        return currentPath.Contains(page, StringComparison.OrdinalIgnoreCase) ? "active" : "";
    }

    private void GoToDashboard()
    {
        Navigation.NavigateTo("/clinician/dashboard");
    }

    private void GoToSettings()
    {
        Navigation.NavigateTo("/clinician/settings");
    }

    private void GoToSupport()
    {
        Navigation.NavigateTo("/clinician/support");
    }

    private async Task OnSearchInput(ChangeEventArgs e)
    {
        searchQuery = e.Value?.ToString() ?? "";
        
        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            searchResults.Clear();
            return;
        }

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
             var clinicianId = Guid.Parse(user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? Guid.Empty.ToString());
             var patients = await UserManagementService.GetPatientsByClinicianAsync(clinicianId);
             
             searchResults = patients
                .Where(p => p.FullName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) || 
                            (p.Condition != null && p.Condition.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)))
                .ToList();
        }
    }

    private void SelectPatient(ApplicationUser patient)
    {
        searchQuery = "";
        searchResults.Clear();
        // Navigate to patient details or dashboard with selected patient
        // For now, just clear search
    }
}
