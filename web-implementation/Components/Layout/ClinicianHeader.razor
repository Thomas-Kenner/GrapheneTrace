@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

@*
    CLINICIAN HEADER COMPONENT
    Author: 2402513, Updated by SID:2412494

    Purpose:
    Unified header for all clinician pages with navigation tabs and user controls.
    Matches the PatientHeader design pattern for consistency.

    How it works:
    - header-left: App branding with "Sensore GrapheneTrace" / "Clinician Dashboard"
    - header-right: Notifications, settings quick-access, and sign out
    - clinician-nav: Clean navigation tabs for clinician sections
*@

<header class="patient-header">
    <div class="header-left">
        <span class="header-brand">Sensore GrapheneTrace</span>
        <span class="header-subtitle">@GetSubtitle()</span>
    </div>
    <div class="header-right">
        <button class="icon-btn" title="Notifications">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
        </button>
        <button class="icon-btn" title="Settings" @onclick="GoToSettings">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6"></path>
                <path d="M21 12h-6m-6 0H3"></path>
            </svg>
        </button>
        <form method="post" action="/account/logout" style="display: inline; margin: 0;">
            <button type="submit" class="btn-signout">Sign Out</button>
        </form>
    </div>
</header>

<nav class="patient-nav">
    <button class="nav-tab @GetNavClass("dashboard")" @onclick="GoToDashboard">Dashboard</button>
    <button class="nav-tab @GetNavClass("patient-list")" @onclick="GoToPatientList">Patient List</button>
    <button class="nav-tab @GetNavClass("contact")" @onclick="GoToContactPatients">Contact Patients</button>
</nav>

@implements IDisposable

@code {
    private string currentPath = "";
    private string userName = "";
    private string userEmail = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userName = authState.User.Identity?.Name ?? "Unknown";

        // Extract email from claims if available
        var emailClaim = authState.User.FindFirst("email");
        userEmail = emailClaim?.Value ?? authState.User.Identity?.Name ?? "clinician@graphene.com";

        currentPath = new Uri(Navigation.Uri).AbsolutePath;
        Navigation.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentPath = new Uri(e.Location).AbsolutePath;
        StateHasChanged();
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }

    private string GetNavClass(string page)
    {
        return currentPath.Contains(page, StringComparison.OrdinalIgnoreCase) ? "active" : "";
    }

    private void GoToDashboard() => Navigation.NavigateTo("/clinician/dashboard");
    private void GoToPatientList() => Navigation.NavigateTo("/clinician/patient-list");
    private void GoToContactPatients() => Navigation.NavigateTo("/clinician/contact");
    private void GoToSettings() => Navigation.NavigateTo("/clinician/settings");

    /// <summary>
    /// Gets the subtitle text based on the current page.
    /// Author: 2402513
    /// Updated: 2402513 - Added dynamic subtitle based on current page route
    /// </summary>
    private string GetSubtitle()
    {
        if (currentPath.Contains("/patient-list", StringComparison.OrdinalIgnoreCase))
        {
            return "Clinician Patient List";
        }
        else if (currentPath.Contains("/patient-details", StringComparison.OrdinalIgnoreCase))
        {
            return "Clinician Patient Details";
        }
        else if (currentPath.Contains("/contact", StringComparison.OrdinalIgnoreCase))
        {
            return "Clinician Contact Patients";
        }
        else
        {
            return "Clinician Dashboard";
        }
    }
}
