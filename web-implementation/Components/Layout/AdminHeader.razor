@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using GrapheneTrace.Web.Services
@implements IDisposable
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManagementService UserManagementService
@inject IJSRuntime JS

@*
    CONSOLIDATED ADMIN HEADER COMPONENT
    Author: 2402513

    Purpose:
    Unified header for all admin pages combining branding, navigation tabs, and user controls.
    Replaces the separate top header and admin header for a cleaner, more integrated design.

    How it works:
    - header-left: App branding (GrapheneTrace.Web)
    - header-center: Navigation tabs for admin sections
    - header-right: Search input and user profile dropdown
    - Shows current user name and email from authentication state

    Why it was done this way:
    - Single consolidated header improves visual hierarchy
    - Reduces redundant header elements
    - Maintains consistent navigation across all admin pages
    - Authentication state is checked once at layout level
*@

<header class="admin-header-consolidated" @ref="headerRef">
    <div class="header-left">
        <a class="header-brand-link" href="/admin/dashboard">
            <span class="header-brand">GrapheneTrace.Web</span>
        </a>
    </div>

    <div class="nav-tabs">
        <button type="button" class="nav-tab @GetNavClass("dashboard")" @onclick="GoToDashboard">Dashboard</button>
        <button type="button" class="nav-tab @GetNavClass("users")" @onclick="GoToUsers">Users</button>
        <!-- Author: 2402513 - Added navigation tab for Patient-Clinician Assignment page -->
        <button type="button" class="nav-tab @GetNavClass("patient-clinician-assignment")" @onclick="GoToPatientClinicianAssignment">Assignments</button>
        <!-- Updated: 2402513 - Added navigation tab for Patient-Clinician Requests page -->
        <button type="button" class="nav-tab @GetNavClass("patient-requests")" @onclick="GoToPatientRequests">Requests</button>
        <button type="button" class="nav-tab @GetNavClass("approvals")" @onclick="GoToApprovals">Approvals</button>
        <button type="button" class="nav-tab @GetNavClass("settings")" @onclick="GoToSettings">Settings</button>
        <button type="button" class="nav-tab @GetNavClass("support")" @onclick="GoToSupport">Support</button>
    </div>

    <div class="header-right">
        <div class="search-container" @onclick:stopPropagation="true">
            <input
                type="text"
                class="search-input"
                placeholder="Search users..."
                @bind="searchQuery"
                @oninput="OnSearchInput"
            />
            @if (searchResults.Count > 0 && !string.IsNullOrWhiteSpace(searchQuery))
            {
                <div class="search-results">
                    @foreach (var user in searchResults.Take(5))
                    {
                        <div class="search-result-item" @onclick="() => SelectUser(user)">
                            <div class="result-name">@user.FirstName @user.LastName</div>
                            <div class="result-email">@user.Email</div>
                        </div>
                    }
                </div>
            }
        </div>
        <div class="profile-section" @onclick:stopPropagation="true">
            <span class="user-email">@userEmail</span>
            <div class="profile-dropdown">
                <button class="user-avatar" type="button" title="User menu" @onclick="ToggleMenu">
                </button>
                @if (isMenuOpen)
                {
                    <div class="profile-menu">
                        <div class="profile-menu-header">
                            <p class="profile-name">@userName</p>
                            <p class="profile-email">@userEmail</p>
                        </div>
                        <form method="post" action="/account/logout" style="margin: 0;">
                            <button type="submit" class="profile-menu-item">
                                <span class="bi bi-box-arrow-right"></span> Sign Out
                            </button>
                        </form>
                    </div>
                }
            </div>
        </div>
    </div>
</header>

@code {
    private bool isMenuOpen = false;
    private string userName = "";
    private string userEmail = "";
    private string currentPath = "";
    private string searchQuery = "";
    private List<Models.ApplicationUser> searchResults = new();
    private ElementReference headerRef;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userName = authState.User.Identity?.Name ?? "Unknown";

        // Extract email from claims if available
        var emailClaim = authState.User.FindFirst("email");
        userEmail = emailClaim?.Value ?? authState.User.Identity?.Name ?? "admin@graphene.com";

        currentPath = new Uri(Navigation.Uri).AbsolutePath;
        
        // Subscribe to location changes to update active state
        Navigation.LocationChanged += OnLocationChanged;
    }
    
    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        currentPath = new Uri(e.Location).AbsolutePath;
        StateHasChanged();
    }
    
    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Add document click listener to close dropdowns when clicking anywhere on the page
            await JS.InvokeVoidAsync("addClickOutsideListener",
                headerRef,
                DotNetObjectReference.Create(this));
        }
        
        // Update current path after navigation
        var newPath = new Uri(Navigation.Uri).AbsolutePath;
        if (newPath != currentPath)
        {
            currentPath = newPath;
        }
    }

    [JSInvokable]
    public void CloseMenu()
    {
        CloseDropdowns();
        StateHasChanged();
    }

    // Author: SID:2412494 - Backwards compatibility alias for old JS function name
    [JSInvokable]
    public void CloseDropdownsFromJS()
    {
        CloseDropdowns();
        StateHasChanged();
    }

    private async Task OnSearchInput(ChangeEventArgs e)
    {
        searchQuery = e.Value?.ToString() ?? "";

        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            searchResults.Clear();
            return;
        }

        // Get all users and filter by search query
        var allUsers = await UserManagementService.GetAllUsersAsync();
        searchResults = allUsers
            .Where(u => u.FirstName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                       u.LastName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                       u.Email.Contains(searchQuery, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private void SelectUser(Models.ApplicationUser user)
    {
        // Navigate to users page with selected user
        Navigation.NavigateTo("/admin/users");
        searchQuery = "";
        searchResults.Clear();
    }

    private void GoToDashboard()
    {
        Navigation.NavigateTo("/admin/dashboard");
        currentPath = "/admin/dashboard";
        StateHasChanged();
    }

    private void GoToUsers()
    {
        Navigation.NavigateTo("/admin/users");
        currentPath = "/admin/users";
        StateHasChanged();
    }

    private void GoToApprovals()
    {
        Navigation.NavigateTo("/admin/approvals");
        currentPath = "/admin/approvals";
        StateHasChanged();
    }

    private void GoToSettings()
    {
        Navigation.NavigateTo("/admin/settings");
        currentPath = "/admin/settings";
        StateHasChanged();
    }

    private void GoToSupport()
    {
        Navigation.NavigateTo("/admin/support");
        currentPath = "/admin/support";
        StateHasChanged();
    }

    /// <summary>
    /// Navigates to the Patient-Clinician Assignment page.
    /// Author: 2402513
    /// </summary>
    /// <remarks>
    /// Purpose: Navigation handler for the new admin assignment management page.
    /// Allows administrators to directly assign patients to clinicians and manage
    /// existing assignments without requiring approval workflow.
    /// </remarks>
    private void GoToPatientClinicianAssignment()
    {
        Navigation.NavigateTo("/admin/patient-clinician-assignment");
        currentPath = "/admin/patient-clinician-assignment";
        StateHasChanged();
    }

    /// <summary>
    /// Navigates to the Patient-Clinician Requests page.
    /// Updated: 2402513
    /// </summary>
    /// <remarks>
    /// Purpose: Navigation handler for the admin request approval page.
    /// Allows administrators to view and approve/deny patient-clinician requests.
    /// </remarks>
    private void GoToPatientRequests()
    {
        Navigation.NavigateTo("/admin/patient-requests");
        currentPath = "/admin/patient-requests";
        StateHasChanged();
    }

    private void ToggleMenu()
    {
        isMenuOpen = !isMenuOpen;
    }

    private void CloseDropdowns()
    {
        // Close both dropdowns when clicking elsewhere in header
        isMenuOpen = false;
        searchQuery = "";
        searchResults.Clear();
    }

    private string GetNavClass(string section)
    {
        // Check if current path matches the section
        if (string.IsNullOrEmpty(currentPath))
        {
            currentPath = new Uri(Navigation.Uri).AbsolutePath;
        }
        
        // Handle dashboard specially since it's the root
        if (section == "dashboard" && (currentPath == "/admin/dashboard" || currentPath == "/admin"))
        {
            return "active";
        }
        
        // For other sections, check if path contains the section name
        return currentPath.Contains(section, StringComparison.OrdinalIgnoreCase) ? "active" : "";
    }
}
